name: Deploy to Cloud Run

on:
  push:
    branches: [main]

env:
  REGION: us-central1
  SERVICE: subscription-backend
  REPO: subscription-backend

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Authenticate to GCP with service account key
      - uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      # Let Docker push to Artifact Registry
      - run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # Build & push image tagged with commit SHA
      - name: Build and push
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/app
          docker build -t $IMAGE:${{ github.sha }} -t $IMAGE:latest .
          docker push $IMAGE --all-tags

      # Deploy to existing Cloud Run service
      - uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE }}
          region: ${{ env.REGION }}
          image: ${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/app:${{ github.sha }}
          flags: --allow-unauthenticated
